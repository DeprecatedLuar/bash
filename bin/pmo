#!/bin/sh
# Power management for postmarketOS

PMO_LIB="$HOME/.config/bash/bin/lib/pmo"
FB_BLANK="/sys/class/graphics/fb0/blank"
BL_PATH="/sys/class/backlight/backlight"
STATE_FILE="/tmp/pmo-state"

set_brightness() {
    max=$(cat "$BL_PATH/max_brightness")
    cur=$(cat "$BL_PATH/brightness")
    case "$1" in
        +*|-*) new=$((cur + (max * ${1} / 100))) ;;
        *)     new=$((max * $1 / 100)) ;;
    esac
    [ "$new" -lt 0 ] && new=0
    [ "$new" -gt "$max" ] && new=$max
    echo "$new" > "$BL_PATH/brightness"
}

start_target() {
    case "$1" in
        kb)  setsid buffyboard >/dev/null 2>&1 & ;;
        btn) setsid thd --triggers "$HOME/.config/triggerhappy/" /dev/input/event* >/dev/null 2>&1 & ;;
        *)   echo "Unknown target: $1" && return 1 ;;
    esac
}

stop_target() {
    case "$1" in
        kb)  pkill -x buffyboard 2>/dev/null; echo 1 > "$FB_BLANK"; echo 0 > "$FB_BLANK" ;;
        btn) pkill -x thd 2>/dev/null ;;
        *)   echo "Unknown target: $1" && return 1 ;;
    esac
}

case "$1" in
    wake)   echo 0 > "$FB_BLANK"; echo awake > "$STATE_FILE" ;;
    sleep)  echo 1 > "$FB_BLANK"; echo sleeping > "$STATE_FILE" ;;
    wake-switch) [ "$(cat "$STATE_FILE" 2>/dev/null)" = "awake" ] && pmo sleep || pmo wake ;;
    status) cat "$STATE_FILE" 2>/dev/null || echo "unknown" ;;
    kb|keyboard)       stop_target kb; start_target kb ;;
    btn|buttons)       stop_target btn; start_target btn ;;
    start)       start_target "$2" ;;
    stop)        stop_target "$2" ;;
    setup)       "$PMO_LIB/setup.sh" ;;
    size)        setfont "ter-1${2}b" || echo "Valid sizes: 12 14 16 18 20 22 24 28 32" ;;
    bl|backlight|lux) set_brightness "$2" ;;
    -e|edit) ${EDITOR:-vi} "$HOME/.config/triggerhappy/buttons.conf" ;;
    *)           echo "Usage: pmo {wake|sleep|wake-switch|status|kb|btn|start|stop|setup|size|bl|-e}" && exit 1 ;;
esac
