#!/bin/bash

DOCK_DIR="/tmp/dock"

undock_single() {
    local VPS_NAME="${1%/}"
    local MOUNT_POINT="$DOCK_DIR/$VPS_NAME"
    local SYMLINK="$HOME/$VPS_NAME"

    if mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
        fusermount -uz "$MOUNT_POINT"
        if mountpoint -q "$MOUNT_POINT"; then
            echo "Undocking $VPS_NAME failed"
            return 1
        fi
        echo "$VPS_NAME undocked"
    fi

    [ -L "$SYMLINK" ] && rm "$SYMLINK"
    [ -d "$MOUNT_POINT" ] && rmdir "$MOUNT_POINT" 2>/dev/null
}

if [ -z "$1" ]; then
    [ -d "$DOCK_DIR" ] || exit 0
    for dir in "$DOCK_DIR"/*; do
        [ -d "$dir" ] && mountpoint -q "$dir" 2>/dev/null && undock_single "$(basename "$dir")"
    done
else
    undock_single "$1"
fi
