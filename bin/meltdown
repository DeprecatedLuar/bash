#!/usr/bin/env bash
#
# meltdown - dead man's switch for NixOS rebuilds
#
# Usage:
#   meltdown <command>        Run command, then start countdown (5 min default)
#   meltdown -N <command>     Override timeout to N minutes
#   meltdown defuse           Cancel the scheduled meltdown
#
# Example:
#   meltdown nixos-rebuild switch
#   meltdown -7 nixos-rebuild switch --upgrade
#   meltdown defuse
#

set -euo pipefail

# Ensure running as root
if [[ $EUID -ne 0 ]]; then
    exec sudo "$0" "$@"
fi

MELTDOWN_FILE="/tmp/.meltdown_job"
TIMEOUT_MINUTES=5
REBOOT_ONLY=false

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

die() { echo -e "${RED}✗ $1${NC}" >&2; exit 1; }
info() { echo -e "${YELLOW}⚠ $1${NC}"; }
success() { echo -e "${GREEN}✓ $1${NC}"; }
bold() { echo -e "${BOLD}$1${NC}"; }

usage() {
    cat <<EOF
meltdown - dead man's switch for NixOS rebuilds

USAGE:
    meltdown <command>              Run command with safety net (5 min default)
    meltdown -N <command>           Override timeout to N minutes
    meltdown -r <cmd>               Only reboot (no rollback, for 'test' mode)
    meltdown defuse                 Cancel scheduled meltdown

EXAMPLE:
    meltdown nixos-rebuild switch
    meltdown -7 nixos-rebuild switch --upgrade
    meltdown -r nixos-rebuild test
    meltdown defuse

TIMEOUT: Default 5 minutes to defuse before action
ACTION: Default is rollback + reboot, use -r for just reboot
EOF
}

check_at_daemon() {
    if ! command -v at &>/dev/null; then
        die "'at' command not found. Add to your NixOS config:\n  services.atd.enable = true;\n  environment.systemPackages = [ pkgs.at ];"
    fi

    if ! systemctl is-active --quiet atd 2>/dev/null; then
        die "atd service not running. Enable it:\n  services.atd.enable = true;"
    fi
}

defuse() {
    if [[ ! -f "$MELTDOWN_FILE" ]]; then
        die "No active meltdown to defuse."
    fi

    job_id=$(cat "$MELTDOWN_FILE")

    if atrm "$job_id" 2>/dev/null; then
        rm -f "$MELTDOWN_FILE"
        success "Meltdown defused. System stable."
    else
        rm -f "$MELTDOWN_FILE"
        die "Failed to cancel job $job_id. It may have already triggered or been cancelled."
    fi
}

arm() {
    check_at_daemon

    if [[ -f "$MELTDOWN_FILE" ]]; then
        existing_job=$(cat "$MELTDOWN_FILE")
        info "Existing meltdown detected (job $existing_job). Replacing..."
        atrm "$existing_job" 2>/dev/null || true
        rm -f "$MELTDOWN_FILE"
    fi

    local meltdown_cmd
    if [[ "$REBOOT_ONLY" == true ]]; then
        meltdown_cmd="reboot"
    else
        meltdown_cmd="nixos-rebuild --rollback boot && reboot"
    fi

    echo -e "${YELLOW}WARNING: Meltdown sequence initiated${NC}"
    echo ""
    info "Running: $*"
    info "Timeout: ${TIMEOUT_MINUTES} minutes after command exits"
    info "On meltdown: $meltdown_cmd"
    echo ""

    # Run the command
    "$@"
    cmd_exit=$?

    echo ""

    if [[ $cmd_exit -ne 0 ]]; then
        info "Command exited with code $cmd_exit"
    fi

    # Schedule the meltdown
    job_output=$(echo "$meltdown_cmd" | at now + ${TIMEOUT_MINUTES} minutes 2>&1)
    job_id=$(echo "$job_output" | grep -oP 'job \K\d+')

    if [[ -z "$job_id" ]]; then
        die "Failed to schedule meltdown. Output: $job_output"
    fi

    echo "$job_id" > "$MELTDOWN_FILE"

    echo ""
    echo "Core meltdown in T-${TIMEOUT_MINUTES} minutes"
    echo ""
    info "Run ${BOLD}meltdown defuse${NC} to stabilize"
    echo ""
}

# Main
case "${1:-}" in
    ""|"-h"|"--help"|"help")
        usage
        exit 0
        ;;
    "defuse"|"abort")
        defuse
        ;;
    "-r"|"--reboot-only")
        REBOOT_ONLY=true
        shift
        if [[ $# -eq 0 ]]; then
            die "No command provided after -r/--reboot-only flag"
        fi
        arm "$@"
        ;;
    -[0-9]*)
        TIMEOUT_MINUTES="${1#-}"
        shift
        if [[ $# -eq 0 ]]; then
            die "No command provided after timeout flag"
        fi
        # Check if next arg is -r or --reboot-only
        if [[ "${1:-}" == "-r" || "${1:-}" == "--reboot-only" ]]; then
            REBOOT_ONLY=true
            shift
        fi
        arm "$@"
        ;;
    *)
        arm "$@"
        ;;
esac
