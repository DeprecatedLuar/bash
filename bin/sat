#!/usr/bin/env bash
# ~/.config/bash/bin/sat - Satellite installer

source "$HOME/.config/bash/modules/universal/paths.sh"

SAT_BASE="https://raw.githubusercontent.com/$GITHUB_USER/the-satellite/main"

case "$1" in
    update)
        cd "$HOME/.config/bash" || exit 1
        git pull
        ;;

    install)
        if [[ -z "$2" ]]; then
            echo "Usage: sat install <program|repo> [program2] [program3] ..."
            exit 1
        fi

        shift

        # Separate wrappers from repos
        WRAPPERS=()
        REPOS=()
        for PROGRAM in "$@"; do
            WRAPPER_URL="$SAT_BASE/cargo-bay/programs/${PROGRAM}.sh"
            if curl -sSL --fail --head "$WRAPPER_URL" >/dev/null 2>&1; then
                WRAPPERS+=("$PROGRAM")
            else
                REPOS+=("$PROGRAM")
            fi
        done

        # Install wrappers via fetcher (downloads to /tmp with deps)
        if [[ ${#WRAPPERS[@]} -gt 0 ]]; then
            source <(curl -sSL "$SAT_BASE/internal/fetcher.sh")
            sat_init
            sat_run_all "${WRAPPERS[@]}"
        fi

        # Install repos via their install.sh
        for REPO in "${REPOS[@]}"; do
            echo "Installing $REPO from repo..."
            curl -sSL "https://raw.githubusercontent.com/$GITHUB_USER/$REPO/main/install.sh" | bash
            echo ""
        done
        ;;

    clone)
        if [[ -z "$2" ]]; then
            echo "Usage: sat clone <repo> [destination]"
            exit 1
        fi
        REPO="$2"

        if [[ -z "$3" ]]; then
            read -p "Where to clone? (default: ./): " DEST
            DEST="${DEST:-.}"
        else
            DEST="$3"
        fi

        echo "Cloning $GITHUB_USER/$REPO to $DEST..."
        git clone "https://github.com/$GITHUB_USER/$REPO.git" "$DEST/$REPO"
        ;;

    list)
        echo "Available programs:"
        curl -sSL "$SAT_BASE/cargo-bay/programs/" 2>/dev/null | grep -oP '[\w-]+\.sh' | sed 's/\.sh$//' | sort
        ;;

    *)
        echo "Usage: sat <command>"
        echo ""
        echo "Commands:"
        echo "  install <program>   - Install program (wrapper or repo)"
        echo "  clone <repo> [dest] - Clone your repo"
        echo "  list                - List available program wrappers"
        echo "  update              - Pull latest bash config"
        ;;
esac