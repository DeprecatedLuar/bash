#!/usr/bin/env bash
# sat - Satellite installer (router)

source "$HOME/.config/bash/modules/universal/paths.sh"
source "$BASHRC/bin/lib/sat/common.sh"

case "$1" in
    install)
        [[ -z "$2" ]] && { echo "Usage: sat install <program> [program2] ..."; exit 1; }
        shift
        source "$BASHRC/bin/lib/sat/install.sh"
        sat_install "$@"
        ;;

    uninstall)
        [[ -z "$2" ]] && { echo "Usage: sat uninstall <program> [program2] ..."; exit 1; }
        shift
        for PROGRAM in "$@"; do
            SOURCE=$(manifest_get "$PROGRAM")
            if [[ -z "$SOURCE" ]]; then
                status "$PROGRAM not tracked by sat"
                continue
            fi
            printf "Removing %s" "$PROGRAM"
            if pkg_remove "$PROGRAM" "$SOURCE" >/dev/null 2>&1; then
                manifest_remove "$PROGRAM"
                status "$PROGRAM removed [$SOURCE]"
            else
                status "$PROGRAM removal failed"
            fi
        done
        ;;

    shell)
        shift
        source "$BASHRC/bin/lib/sat/shell.sh"
        sat_shell "$@"
        ;;

    list)
        if [[ "$2" == "-i" || "$2" == "--installed" ]]; then
            echo "Installed via sat:"
            while IFS='=' read -r prog source; do
                [[ -n "$prog" ]] && printf "  %-20s [%s]\n" "$prog" "$source"
            done < "$SAT_MANIFEST"
        else
            echo "Available wrappers:"
            curl -sSL "$SAT_BASE/cargo-bay/programs/" 2>/dev/null | grep -oP '[\w-]+\.sh' | sed 's/\.sh$//' | sort
        fi
        ;;

    clone)
        [[ -z "$2" ]] && { echo "Usage: sat clone <repo> [destination]"; exit 1; }
        REPO="$2"
        DEST="${3:-.}"
        [[ -z "$3" ]] && read -p "Where to clone? (default: ./): " DEST && DEST="${DEST:-.}"
        echo "Cloning $GITHUB_USER/$REPO to $DEST..."
        git clone "https://github.com/$GITHUB_USER/$REPO.git" "$DEST/$REPO"
        ;;

    update)
        cd "$HOME/.config/bash" || exit 1
        git pull
        ;;

    *)
        cat << 'EOF'
         ,-.
        / \  `.  __..-,O
       :   \ --''_..-'.'
       |    . .-' `. '.
       :     .     .`.'
        \     `.  /  ..
         \      `.   ' .
          `,       `.   \
         ,|,`.        `-.\
        '.||  ``-...__..-`
         |  |
         |__|
         /||\    Usage: sat <command>
        //||\\
       // || \\
    __//__||__\\__
   '--------------'

Commands:
  install <program>   - Install program (native > repo > uv > npm > wrapper)
  uninstall <program> - Remove program installed via sat
  shell <tool>        - Temp shell with tools, auto-cleanup on exit
  list                - List available wrappers
  list -i             - List installed programs
  clone <repo> [dest] - Clone your repo
  update              - Pull latest bash config
EOF
        ;;
esac
